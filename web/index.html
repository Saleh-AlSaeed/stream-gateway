<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>محوّل بث HLS يعمل في المتصفحات (SRT/UDP/HLS)</title>
  <style>
    body{background:#0f1115;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:22px;margin:10px 0 18px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    input[type="text"]{flex:1;background:#1a1d24;color:#e5e7eb;border:1px solid #2a2f3a;border-radius:10px;padding:12px 14px;outline:none}
    input[readonly]{opacity:.9}
    button{background:#2d6cdf;border:none;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer}
    button.secondary{background:#374151}
    button:disabled{opacity:.6;cursor:not-allowed}
    .panel{background:#11151c;border:1px solid #2a2f3a;border-radius:14px;padding:14px;margin-top:12px}
    video{width:100%;aspect-ratio:16/9;background:#000;border-radius:10px}
    .muted{opacity:.7;font-size:12px}
    .badge{display:inline-block;border-radius:999px;padding:3px 10px;font-size:12px;margin-inline-start:8px;border:1px solid transparent}
    .badge.wait{color:#9ca3af;border-color:#374151}
    .badge.ok{color:#22c55e;border-color:#14532d;background:#062e12}
    .badge.err{color:#ef4444;border-color:#7f1d1d;background:#2a0b0b}
    textarea#debug{width:100%;height:140px;background:#0b0e13;color:#9ca3af;border:1px dashed #334155;border-radius:10px;padding:10px;white-space:pre;overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>
      محوّل بث HLS يعمل في المتصفحات
      <span id="statusBadge" class="badge wait">بانتظار…</span>
    </h1>

    <!-- رابط المصدر + إنشاء -->
    <div class="row">
      <input id="src" type="text" placeholder="ضع هنا رابط SRT/UDP/m3u8 (مثال: https://…/playlist.m3u8)">
      <select id="mode">
        <option value="copy" selected>Copy (حافظ على الجودة إن أمكن)</option>
        <option value="transcode">Transcode (x264/aac)</option>
      </select>
      <button id="btnCreate">إنشاء رابط جديد</button>
    </div>

    <!-- رابط الإخراج + نسخ -->
    <div class="row">
      <input id="out" type="text" placeholder="سيظهر هنا رابط HLS النهائي" readonly>
      <button id="btnCopy" class="secondary">نسخ</button>
      <button id="btnCopyPublic">نسخ الرابط العام</button>
    </div>

    <!-- المعاينة -->
    <div class="panel">
      <video id="player" controls playsinline></video>
      <div class="muted" style="margin-top:6px">ملحوظة: قد يستغرق الإنشاء أول مرة لحظات. ننتظر تلقائيًا حتى يصبح الـ manifest جاهز.</div>
    </div>

    <!-- Debug -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>Debug</b>
        <button id="btnClear" class="secondary">مسح</button>
      </div>
      <textarea id="debug" readonly></textarea>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $src   = $('#src');
  const $mode  = $('#mode');
  const $out   = $('#out');
  const $btnC  = $('#btnCreate');
  const $btnCp = $('#btnCopy');
  const $btnPub= $('#btnCopyPublic');
  const $video = $('#player');
  const $log   = $('#debug');
  const $badge = $('#statusBadge');

  function logLine(msg){
    const t = new Date().toLocaleTimeString('ar-SA', { hour12:false });
    $log.value += `[${t}] ${msg}\n`;
    $log.scrollTop = $log.scrollHeight;
  }
  function setBadge(kind, text){
    $badge.className = 'badge ' + kind; $badge.textContent = text;
  }

  async function waitManifestReady(urlRel, maxTries=20){
    setBadge('wait','بانتظار…');
    for (let i=0;i<maxTries;i++){
      try{
        const r = await fetch(urlRel, { method:'HEAD', cache:'no-store' });
        if (r.ok){ setBadge('ok','جاهز'); return true; }
      }catch(e){}
      await new Promise(r=>setTimeout(r,700));
    }
    setBadge('err','فشل');
    return false;
  }

  async function createLink(){
    const srcUrl = ($src.value || '').trim();
    const mode   = ($mode.value || 'copy').trim();
    if (!srcUrl){ alert('ضع رابط المصدر أولاً'); return; }

    logLine(`api/create src="${srcUrl}" mode=${mode}`);
    const res = await fetch('/api/create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ srcUrl, mode })
    });
    const txt = await res.text();
    if (!res.ok){
      logLine(`HTTP ${res.status} ${txt}`);
      alert('فشل إنشاء الرابط');
      setBadge('err','فشل');
      return;
    }
    let data;
    try{ data = JSON.parse(txt); }catch{ logLine(txt); return; }

    const rel = `/hls/${data.id}/index.m3u8`;
    const abs = `${location.origin}${rel}`;
    $out.value = abs;
    logLine(`OK id=${data.id} url=${abs}`);

    // شغّل المعاينة
    await waitManifestReady(rel);
    try {
      if (window.hls) { try{window.hls.destroy();}catch{} }
      if (window.Hls && Hls.isSupported()) {
        window.hls = new Hls({ maxBufferLength: 10 });
        window.hls.loadSource(rel);
        window.hls.attachMedia($video);
        $video.muted = true; $video.play().catch(()=>{});
      } else if ($video.canPlayType('application/vnd.apple.mpegurl')) {
        $video.src = rel; $video.muted = true; $video.play().catch(()=>{});
      } else {
        alert('HLS غير مدعوم على هذا المتصفح');
      }
    } catch(e){
      logLine('خطأ تشغيل المعاينة: ' + e.message);
    }
  }

  // أزرار
  $btnC.addEventListener('click', (e)=>{ e.preventDefault(); createLink(); });
  $btnCp.addEventListener('click', (e)=>{ e.preventDefault(); if(!$out.value) return; navigator.clipboard.writeText($out.value); });
  $btnPub.addEventListener('click', (e)=>{ e.preventDefault(); if(!$out.value) return; navigator.clipboard.writeText($out.value); });
  $('#btnClear').addEventListener('click', ()=>{ $log.value=''; });

  // قيمة افتراضية لتجربة سريعة
  $src.value = $src.value || 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
})();
</script>
</body>
</html>
